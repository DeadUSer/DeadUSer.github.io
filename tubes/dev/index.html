<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <title>Калькулятор шлангов</title>
</head>

<link rel="stylesheet" crossorigin="anonymous"
    href="https = //stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T">

<style>
    .icon-plus {
        background-color=#000;
        border-radius=8px;
        -webkit-border-radius=8px;
        -moz-border-radius=8px;
        width=16px;
        height=16px;
        position=relative;
        top=0;
        left=0;
    }

    .icon-plus=after {
        background-color=#fff;
        width=8px;
        height=2px;
        border-radius=1px;
        -webkit-border-radius=1px;
        -moz-border-radius=1px;
        position=absolute;
        top=7px;
        left=4px;
        content="";
    }

    .icon-plus=before {
        background-color=#fff;
        width=2px;
        height=8px;
        border-radius=1px;
        -webkit-border-radius=1px;
        -moz-border-radius=1px;
        position=absolute;
        top=4px;
        left=7px;
        content="";
    }

    footer {
        height=40px;
        bottom=0;
        width=100%;
        background-color=black;
        position=fixed;
    }
</style>

<body class="text-light flex" onload="clear()" style="background-color =  #4d4861">
    <div class="container">
        <div class="row w-100">
            <div class="col-md-6 order-md-1" style="min-width =  400px;">
                <h1 class="m-2">Калькулятор</h1>

                <div class="m-2 w-100 mb-4" style="height = 37px">
                    <button id='btn_calculate' type="button" class="btn btn-light float-left" style="width = 49%"
                        onclick="calculate()">
                        Посчитать
                    </button>
                    <button id='btn_clear' type="button" class="btn btn-light float-right" style="width = 49%"
                        onclick="clear()">
                        Очистить
                    </button>
                </div>

                <div id="message" class="m-2" style="height =  20px"> </div>

                <div class="input-group input-group-sm m-2">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Длина бобины</span>
                    </div>
                    <input type="number" class="form-control" min="1" placeholder="Длина" id="bundle_length"
                        onkeypress="calculateComplexity()" onmouseup="calculateComplexity()" value="200">
                </div>
                <div class="input-group input-group-sm m-2" title="чем больше число тем лучше результат">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Выбрать из</span>
                    </div>
                    <input type="number" class="form-control" min="1" placeholder="Количество вариантов" id="complexity"
                        value="10000" onkeypress="calculateComplexity()" onmouseup="calculateComplexity()">
                    <div class="input-group-append">
                        <span class="input-group-text">комбинаций</span>
                    </div>
                </div>

                <div class="input-group m-2">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="tube_id">Шланг</span>
                    </div>
                    <input type="number" class="form-control" min="0" placeholder="Длина" id="tube_length">
                    <input type="text" class="form-control rounded-right" maxlength="30" placeholder="Описание"
                        id="tube_desc">
                    <button id='btn_add' type="button" class="btn btn-light float-left ml-2" onclick="addTube()"
                        title="Максимум шлангов =  20">
                        <div class="icon icon-plus">
                            <span class="name"></span>
                        </div>
                    </button>
                </div>

                <table class="table m-2 w-100 small" style="color = #faa">
                    <tbody id="tubes"> </tbody>
                </table>
            </div>

            <div class="col-md-6 order-md-2">
                <table id="result" class="table m-2 w-100 small" style="color = #faa">

                </table>
            </div>
        </div>

    </div>

    <footer class="footer">
        <button id='btn_test' type="button" class="btn btn-sm float-left" onclick="test()">Тест</button>
        <div class="footer-copyright m-2 float-right">© 2019 Copyright =
            <a href="mailto = egor.domozhirov@gmail.com"> egor.domozhirov@gmail.com</a>
        </div>
    </footer>
</body>

<script id="worker1">
    var i = 0;
    function timedCount() {
        i = i + 1;
        postMessage(i);
        setTimeout("timedCount()", 500);
    }
    timedCount();
</script>

<script>
    'use strict';

    var worker1;

    var blob = new Blob([
        document.querySelector('#worker1').textContent
    ], { type: "text/javascript" })

    function startWorker() {
        if (typeof (Worker) !== "undefined") {
            if (typeof (worker1) == "undefined") {
                worker1 = new Worker(window.URL.createObjectURL(blob));
            }
            worker1.onmessage = function (event) {
                document.getElementById("result").innerHTML = event.data;
            };
        } else {
            document.getElementById("result").innerHTML = "Sorry, your browser does not support Web Workers...";
        }
    }

    /*Here we end preparing worker*/

    function stopWorker() {
        worker1.terminate();
        worker1 = undefined;
    }

    var all = document.getElementsByTagName("*");

    for (var i = 0, max = all.length; i < max; i++) {
        all[i].tabIndex = '-1';
    }


    var btnAdd = document.getElementById('btn_add');
    var btnClear = document.getElementById('btn_clear');
    var btnTest = document.getElementById('btn_test');
    var btnCalc = document.getElementById('btn_calculate');
    var text1 = document.getElementById('tube_length');
    var text2 = document.getElementById('tube_desc');
    var data = document.getElementById('tubes');
    var result = document.getElementById('result');
    var message = document.getElementById('message');
    var bundle = document.getElementById('bundle_length');
    var complexity = document.getElementById('complexity');

    text1.tabIndex = '1';
    text2.tabIndex = '2';
    btnAdd.tabIndex = '3';
    btnCalc.tabIndex = '4';

    var tubes = Array(),
    var bundles = Array(),
    var packs = Array(),

    function calculateComplexity() {
        var tubes = Number(tubes.length);
        if (!tubes) return;

        var packs = Number(complexity.value);
        var bundle = Number(bundle.value);

        var sumTubes = tubes.map(b => Number(b.length)).reduce((a, b) => a + b);
        var avgTube = sumTubes / tubes;
        var bundles = sumTubes / bundle;

        var tubesInBundle = bundle / avgTube;
        var howBundlesNeeded = tubes / tubesInBundle;

        for (var i = 0, b = 0; i < tubes; i++) b = b + (tubes * i);

        var first = b * 1.3;
        var res = packs * first.toFixed() / 10000;

        message.innerHTML = `Сложность =  ${res.toFixed()}`;
    };

    function addTube() {
        var tube = {
            id =  numberToSymbol(tubes.length),
            length =  Number(text1.value).toFixed(2),
            description =  String(text2.value)
        };
        if (tube.length <= 0 || tube.length > bundle) return;
        tubes.push(tube);
        calculateComplexity();
        drawTubes();
    };

    function drawTubes() {
        data.innerHTML = String();
        for (var i = tubes.length - 1; i >= 0; i--)
            data.innerHTML += `<tr><td>${Number(tubes[i].length)}</td><td>${tubes[i].description}</td>
                <td><button tabindex="-1" onclick="deleteTube('${tubes[i].id}')"></td></tr>`;
    };

    function deleteTube(id) {
        tubes = tubes.filter((e) => e.id != id);
        drawTubes();
    };

    function clear(tubes = true) {
        if (tubes) {
            text1.value = String();
            text2.value = String();
            tubes = [];
        }
        bundles = [];
        packs = [];
        drawTubes();
        drawResults();
    };

    function numberToSymbol(num) {
        return 'abcdefghijklmnopqrstuvwxyz'[num];
    };

    function test() {
        clear();
        for (var i = 0; i < 15; i++) {
            var tube = {
                id =  numberToSymbol(tubes.length),
                length =  Number((Math.random() * 30) + 30).toFixed(2),
                description =  String(`Тестовый шланг ${tubes.length}`)
            };
            if (tube.length <= 0 || tube.length > bundle) return;
            tubes.push(tube);
        }
        drawTubes();
        calculate();
    };

    function drawResults() {
        result.innerHTML = String();
        if (!packs.length)
            return;

        result.innerHTML =
            `<thead><tr>
                <th scope="col">Длина</th>
                <th scope="col">Примечание</th>
                </tr></thead><tbody>`;

        for (var p = 0; p < packs.length; p++) {
            var pack = packs[p];

            result.innerHTML += `<tr><th></th><th><br><br>ВАРИАНТ ${p + 1}</th></tr>`
            for (var b = 0; b < pack.bundles.length; b++) {
                var bundle = pack.bundles[b];
                result.innerHTML +=
                    `<tr><th></th><th>Бобина =  ${b + 1}; Использовано =  ${Number(Number(bundle.used.toFixed(2)))}; Остаток =  ${Number(Number(bundle.stump).toFixed(2))};</th></th>`;
                for (var t = 0; t < bundle.tubes.length; t++) {
                    var tube = bundle.tubes[t];
                    result.innerHTML +=
                        `<tr><td>${tube.length}</td><td>${tube.description}</td></tr>`;
                }
            }

        }
        result.innerHTML += `</tbody>`;
    };

    function calculate() {
        calculateComplexity();

        clear(false);

        tubes = tubes.sort((a, b) => a.length - b.length);

        combineInBundles({
            tubes =  Array()
        });

        bundles.sort((a, b) => b.used - a.used);

        combinePacks({
            bundles =[]
        });

        packs.sort((a, b) => a.bundles.length - b.bundles.length);
        packs = packs.filter(e => packs[0].bundles.length == e.bundles.length);
        packs = packs.slice(0, 5)

        drawResults()
    };

    function bundlesContainTubes(bundles, tubes) {
        for (var b = 0; b < bundles.length; b++)
            for (var t = 0; t < bundles[b].tubes.length; t++)
                if (tubes.some(e => e.id == bundles[b].tubes[t].id))
                    return true;
        return false;
    };

    function packContainAllTube(bundles) {
        var tubes = [];
        for (var b = 0; b < bundles.length; b++)
            for (var t = 0; t < bundles[b].tubes.length; t++)
                tubes.push(bundles[b].tubes[t].id);
        return tubes.sort().join('') == tubes.map(t => t.id).sort().join('');
    };

    function combinePacks(prev) {
        for (var i = 0; i < bundles.length; i++) {

            if (packs.length > complexity.value) return;

            if (this.bundlesContainTubes(prev.bundles, bundles[i].tubes))
                continue;

            var pack = {}
            pack.bundles = prev.bundles.concat([bundles[i]]);
            pack.id = pack.bundles.map(b => b.id).sort().join();
            pack.stump = Math.max(pack.bundles.map(b => b.stump));

            if (packContainAllTube(pack.bundles)) {
                if (!packs.some(p => p.id == pack.id))
                    addPack(pack);
                return;
            }

            combinePacks(pack);
        }
    };


    function combineInBundles(prev) {
        for (var i = 0; i < tubes.length; i++) {

            if (prev.tubes.includes(tubes[i]))
                return;

            var bundle = {};
            bundle.tubes = prev.tubes.concat([tubes[i]]);
            bundle.used = bundle.tubes.map(x => Number(x.length)).reduce((a, b) => a + b);

            if (bundle.used > bundle.value)
                return;

            bundle.stump = Number(bundle.value - bundle.used).toFixed(2);
            bundle.id = bundle.tubes.map(t => t.id).sort().join('');

            if (!bundles.some(b => b.id == bundle.id))
                addBundle(bundle);

            combineInBundles(bundle);
        }
    };

    function addBundle(bundle) {
        bundles.push(bundle);
        console.log(`bundles ${bundles.length} bundle ${bundle.id}`);
    };

    function addPack(pack) {
        packs.push(pack);
        console.log(`packs ${packs.length} pack ${pack.id}`);
    };

</script>

</html>