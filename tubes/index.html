<!DOCTYPE html>

<html>

<link rel="stylesheet" crossorigin="anonymous"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T">
<script src="https://cdn.jsdelivr.net/lodash/4.10.0/lodash.js"></script>


<body class="text-light" onload="restart()" style="background-color: #000033">
    <div class="container">
        <div class="row w-100">
            <div class="col-md-8 order-md-1">

                <h4 class="m-2">Калькулятор шлангов</h4>
                <input id="txt_amount" type="number" max="200" class="form-control m-2"
                    placeholder="Введите количество шлангов" value="10">
                <div class="m-2 w-100" style="height:50px">
                    <button type="button" class="btn btn-light float-left" style="width:49%" onclick="addInputs()">
                        Сгенерировать
                    </button>
                    <button type="button" class="btn btn-light float-right" style="width:49%" onclick="restart()">
                        Отчистить
                    </button>

                </div>

                <div id="inputs" class="m-2"></div>
                <button type="button" class="btn btn-light m-2 w-100" onclick="calculate()">Посчитать</button>
                <div class="progress ml-2 w-100">
                    <div id="bar_progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"
                        aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <h4 id="result" class="m-2" style="color:red"></h4>
            </div>
            <div class="col-md-4 order-md-2">
                <div class="m-2">
                    <br>максимум шлангов: 20
                    <br>длина бобины: 200
                    <div class="form-check ">
                        <input type="checkbox" checked class="form-check-input" id="test_data">
                        <label class="form-check-label" for="exampleCheck1">Тестовые данные</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<script>
    function restart() {
        showProgress(0, 100);
        current = Number();
        tubes = Array();
        nodes = Array();
        bundles = Array();
        combinationsBundles = Array();
        combinationsBundlesWithAllTubes = Array();
        map = String();
        bundleLength = Number(200);
        maxTubes = Number(20);
        document.getElementById('inputs').innerHTML = String();
        iterate = Number(0);
    }

    function getTubeId(num) {
        return String('abcdefghijklmnopqrstuvwxyz'[num]);
    }

    function addInputs() {
        var testData = document.getElementById('test_data').checked;
        var howMach = document.getElementById('txt_amount').value;
        for (var i = 0; i < howMach; i++) addInput(testData);
        current = 0;
    }

    function addInput(testData) {
        if (current < maxTubes) {
            var val = (testData) ? String((Math.random() * 50 + 20).toFixed()) : "";
            document.getElementById('inputs').innerHTML +=
                '<input type="number" max="200" class="form-control m-1 tube" placeholder="Введите длину шланга" value="' + val + '">';
            current++;
        }
    }

    function showProgress(cur, all) {
        var percent = (cur / all) * 100;
        var progress = document.getElementById('bar_progress');
        progress.style.width = percent + '%';
    }

    function showProgress(per) {
        var percent = per * 100;
        var progress = document.getElementById('bar_progress');
        progress.style.width = String(Math.trunc(percent)) + '%';
    }

    function calculate() {
        showProgress(0, 100);

        var elements = document.getElementsByClassName('tube');

        for (var i = 0; i < elements.length; i++)
            tubes.push({
                id: String(getTubeId(i)),
                length: Number(elements[i].value).toFixed(2),
            });

        map = _.sortBy(_.map(tubes, 'id'));

        buildTree({
            id: "root",
            tubes: Array(),
            length: Number(),
        });

        calculateCombinationsBundles({ id: "root", tubes: [], bundles: [] });
        debugger;

        var combs = getCombinationsBundlesContainsAllTubes();
        var topFive = combs.slice(0, 4);
        debugger;

        showBestResults(topFive)

        showProgress(100, 100);
    }

    function showBestResults(topFive) {
        var result = document.getElementById('result');
        result.innerHTML = '';
        for (var i = 0; i < topFive.length; i++) {
            result.innerHTML += '';

        }
        result.innerHTML += 'overpayment: ' + String(Math.trunc(overpayment)) + '<br>';
    }

    function getCombinationsBundlesContainsAllTubes() {
        var combs = _.filter(combinationsBundles, function (o) { return o.tubes == map });
        return _.sortBy(combs, ['bundles.length']);
    }

    function calculateCombinationsBundles(curCombination) {
        if (combinationsBundlesWithAllTubes > 100) return;

        for (var i = 0; i < bundles.length; i++) {
            if (_.intersection(curCombination.tubes, bundles[i].tubes).length == 0) {

                var concat = _.sortBy(_.concat(bundles[i].tubes, curCombination.tubes)).join('');
                var combination = _.concat(curCombination.bundles, [bundles[i]]);
                var newCombinations = {
                    tubes: concat,
                    bundles: combination
                };
                combinationsBundles.push(newCombinations);

                if (_.isEqual(newCombinations.concat, map))
                    combinationsBundlesWithAllTubes.push(newCombinations);
                else
                    calculateCombinationsBundles(newCombinations);
            }
        }
    }

    function addBundle(tubes, length) {
        tubes = tubes.sort();
        var map = bundles.map(x => x.tubes).i
        if (_.findIndex(bundles, function (o) { return _.isEqual(o.tubes, tubes); }) === -1)
            bundles.push({
                id: bundles.length,
                tubes: tubes,
                useful: Number(length),
                spent: Number(bundleLength)
            });
    }

    function equals(a, b) {
        if (a.length != b.length) return false;

        var i = a.length;
        while (i--)
            if (a[i] !== b[i]) return false;

        return true;
    }

    function buildTree(prev) {
        for (var i = 0; i < tubes.length; i++) {

            if (prev.tubes.includes(tubes[i].id))
                continue;

            var node = {
                tubes: prev.concat(tubes[i].id).sort(),
                length: prev.length + tubes[i].length,
            };

            if (node.length > 200)
                continue;

            addBundle(node.tubes, node.length);

            buildTree(node);
        }
    }
</script>

</html>